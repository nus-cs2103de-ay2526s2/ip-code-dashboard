name: Deploy RepoSense Dashboard

on:
  push:
    branches: [ master ]
  schedule:
    - cron: "0 0 * * *"   # daily at 00:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: pip install --upgrade pip requests

      - name: Download RepoSense
        run: |
          chmod +x get-reposense.py
          ./get-reposense.py --release --overwrite
          ls -la RepoSense.jar

      - name: Generate RepoSense report
        run: |
          set -euxo pipefail

          rm -rf reposense-report

          java -version

          # Run RepoSense (edit dates/formats as needed)
          java --add-opens java.base/java.time=ALL-UNNAMED -jar RepoSense.jar \
            --config ./configs \
            --since 01/01/2026 \
            --formats java md fxml sh bat gradle txt \
            --timezone Asia/Singapore \
            --last-modified-date \
            --output reposense-report

          # Ensure Pages serves static files
          touch reposense-report/.nojekyll

          # Optional: set report title if summary.json exists
          if [ -f "reposense-report/summary.json" ]; then
            python3 - <<'PY'
import json
p = "reposense-report/summary.json"
with open(p, "r", encoding="utf-8") as f:
    data = json.load(f)
data["reportTitle"] = "CS2103DE Software Engineering iP Code Dashboard"
with open(p, "w", encoding="utf-8") as f:
    json.dump(data, f, ensure_ascii=False)
PY
          fi

          echo "=== reposense-report contents ==="
          ls -la reposense-report
          test -f reposense-report/index.html
          test -f reposense-report/archive.zip

      - name: Deploy to GitHub Pages (gh-pages branch)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reposense-report
          force_orphan: true
          enable_jekyll: false
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
          commit_message: "docs: update RepoSense report"
