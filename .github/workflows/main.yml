name: Deploy RepoSense Dashboard

on:
  push:
    branches: [ master ]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Download RepoSense
        run: |
          chmod +x get-reposense.py
          ./get-reposense.py --release --overwrite
          ls -la RepoSense.jar

      - name: Generate RepoSense report
        run: |
          set -euxo pipefail
          rm -rf reposense-report

          java -version

          java --add-opens java.base/java.time=ALL-UNNAMED -jar RepoSense.jar \
            --config ./configs \
            --since 01/01/2026 \
            --until 31/12/2026 \
            --formats java md txt \
            --timezone Asia/Singapore \
            --last-modified-date \
            --output reposense-report

          # RepoSense sometimes outputs to reposense-report/reposense-report
          if [ -d "reposense-report/reposense-report" ]; then
            mv reposense-report/reposense-report/* reposense-report/
            rm -rf reposense-report/reposense-report
          fi

          touch reposense-report/.nojekyll

          # Set report title if summary.json exists (no heredoc)
          if [ -f "reposense-report/summary.json" ]; then
            python3 -c "import json; p='reposense-report/summary.json'; d=json.load(open(p,'r',encoding='utf-8')); d['reportTitle']='CS2103DE Software Engineering iP Code Dashboard'; json.dump(d, open(p,'w',encoding='utf-8'), ensure_ascii=False)"
          fi

          echo "=== reposense-report contents ==="
          ls -la reposense-report
          test -f reposense-report/index.html

      - name: Deploy to GitHub Pages (gh-pages branch)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reposense-report
          force_orphan: true
          enable_jekyll: false
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
          commit_message: "docs: update RepoSense report"
